name: debug (JSON)

on:
  workflow_dispatch:
    inputs:
      board_choice:
        description: "Select a board"
        required: true
        default: "Marauder v7"
        type: choice
        options:
          - Flipper Zero WiFi Dev Board
          - Flipper Zero Multi Board S3
          - OG Marauder
          - Marauder v6
          - Marauder v6.1
          - Marauder Kit
          - Marauder Mini
          - ESP32 LDDB
          - Marauder Dev Board Pro
          - M5StickCPlus
          - M5StickCPlus 2
          - Rev Feather
          - Marauder v7
          - Marauder CYD 2432S028
          - Marauder CYD 2432S024 GUITION
          - Marauder CYD 2432S028 2 USB
          - Marauder v7.1
          - M5Cardputer
          - ESP32-C5-DevKitC-1
          - Generic ESP32 Dev Module
      core_choice:
        description: "ESP32 core version"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - 2.0.10
          - 3.3.0

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure system deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq unzip rsync

      - name: Ensure Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          pip install pyserial

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 0.35.3

      - name: Configure ESP32 board manager
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli config init
          arduino-cli config set board_manager.additional_urls \
            https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index --additional-urls \
            https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # --- Inputs -> ENV priming ---
      - name: Seed selector env from inputs
        shell: bash
        run: |
          set -euo pipefail
          echo "BOARD_LABEL=${{ github.event.inputs.board_choice }}" >> $GITHUB_ENV
          echo "CORE_CHOICE=${{ github.event.inputs.core_choice }}" >> $GITHUB_ENV

      # --- Manifest probe (preview the row we will load) ---
      - name: Manifest probe (board row preview)
        shell: bash
        run: |
          set -euo pipefail
          MAN="scaffold/configs/boards/boards_manifest.json"
          test -f "$MAN" || { echo "::error::Missing $MAN"; exit 1; }
          echo ">> Looking up BOARD_LABEL='${BOARD_LABEL:-}' in $MAN"
          jq -r '
            def rows:
              if type=="array" then .
              elif type=="object" and .boards then .boards
              elif type=="object" then [ to_entries[] | {flag:.key} + (.value) ]
              else [] end;
            rows | map(select((.board_label//"")==env.BOARD_LABEL)) | .[0] // {}
          ' "$MAN"

      # --- Export env from manifest (authoritative) ---
      - name: Export board env from JSON manifest
        shell: bash
        run: |
          set -euo pipefail
          : > exporter.err
          python3 scaffold/tools/export_env_from_json.py >> $GITHUB_ENV 2>> exporter.err || true
          echo "----- exporter stderr -----"
          cat exporter.err || true

      # Map exporter FLAG -> BOARD_FLAG (no fallbacks allowed)
      - name: Normalize env from exporter (strict)
        shell: bash
        run: |
          set -euo pipefail
          # If exporter emitted FLAG, mirror to BOARD_FLAG
          if [ -n "${FLAG:-}" ]; then
            echo "BOARD_FLAG=$FLAG" >> $GITHUB_ENV
            echo "BOARD_FLAG_SOURCE=exporter" >> $GITHUB_ENV
          fi

          # Core version: 'auto' uses manifest; explicit overrides it
          case "${CORE_CHOICE:-auto}" in
            auto)
              if [ -n "${CORE_VERSION:-}" ]; then
                echo "::notice::Using core from manifest: $CORE_VERSION"
              else
                echo "::error::CORE_VERSION is empty in manifest for '${BOARD_LABEL:-}'."
                exit 1
              fi
              ;;
            *)
              echo "CORE_VERSION=${CORE_CHOICE}" >> $GITHUB_ENV
              echo "::notice::Overriding core to ${CORE_CHOICE}"
              ;;
          esac

      # Strict asserts: everything must come from the manifest / exporter
      - name: Assert required fields from manifest
        shell: bash
        run: |
          set -euo pipefail
          MERR=0
          if [ -z "${BOARD_LABEL:-}" ];  then echo "::error::BOARD_LABEL empty";  MERR=1; fi
          if [ -z "${BOARD_FLAG:-}" ];   then echo "::error::BOARD_FLAG empty (exporter must emit FLAG)"; MERR=1; fi
          if [ -z "${FQBN:-}" ];         then echo "::error::FQBN empty (manifest must provide fqbn/fbqn)"; MERR=1; fi
          if [ -z "${CORE_VERSION:-}" ]; then echo "::error::CORE_VERSION empty"; MERR=1; fi
          if [ $MERR -ne 0 ]; then
            echo "----- Debug env dump -----"
            env | sort | grep -E '^(BOARD_LABEL|BOARD_FLAG|FLAG|FQBN|CORE_VERSION|FILESYSTEM|PARTITION)=' || true
            echo "----- exporter.err -----"
            cat exporter.err || true
            exit 1
          fi

      - name: Install ESP32 core (with retry)
        shell: bash
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            arduino-cli core install "esp32:esp32@${CORE_VERSION}" \
              --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json && break || {
                echo "Install attempt $i failed; retrying in 5s..."
                sleep 5
              }
          done
          arduino-cli core list

      - name: Clean conflicting libraries (touch/TFT leftovers)
        shell: bash
        run: |
          set -euo pipefail
          LIBDIR="$HOME/Arduino/libraries"
          mkdir -p "$LIBDIR"
          cd "$LIBDIR"
          rm -rf XPT2049Touch XPT2046_Touchscreen TFT_eSPI || true

      - name: Extract pre-bundled libs (JSON-driven)
        shell: bash
        run: |
          set -euo pipefail
          JSON="scaffold/configs/libs/lib_list.json"
          ZIPROOT="scaffold/lib"
          LIBDIR="$HOME/Arduino/libraries"
          mkdir -p "$LIBDIR"

          test -f "$JSON" || { echo "::error ::$JSON not found"; exit 1; }

          echo "lib_list.json (first 200 bytes):"
          head -c 200 "$JSON" || true; echo

          mapfile -t ZIPS < <(jq -r '
            def aszip:
              if type=="string" then .
              elif type=="object" then ( .zip // .["# zip_file"] // empty )
              else empty end;
            if type=="array" then map(aszip)[]
            elif type=="object" and .libs then (.libs | map(aszip)[])
            else empty end
            | select(. != null and . != "")
          ' "$JSON")

          if [ "${#ZIPS[@]}" -eq 0 ]; then
            echo "::error ::No ZIP entries found in $JSON. Expected array of zips or {\"libs\":[...]}, items as strings or {zip}/{\"# zip_file\"}."
            exit 1
          fi

          echo "Found ${#ZIPS[@]} zip(s):"
          for z in "${ZIPS[@]}"; do echo "  - $z"; done

          for ZIP in "${ZIPS[@]}"; do
            FILE="$ZIPROOT/$ZIP"
            if [ -f "$FILE" ]; then
              echo "Unpacking $ZIP -> $LIBDIR"
              unzip -o "$FILE" -d "$LIBDIR" >/dev/null
            else
              echo "::warning ::$ZIP not found at $ZIPROOT"
            fi
          done

          echo "Installed libs under $LIBDIR:"
          find "$LIBDIR" -maxdepth 2 -type f | sed 's/^/  /' || true

      # ---------- Stage sketch ----------
      - name: Prepare Sketch Folder
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          SKETCH_DIR="${PWD}/_build/esp32_marauder_rewired"
          rm -rf "$SKETCH_DIR"; mkdir -p "$SKETCH_DIR"
          SRC_INO="$(ls scaffold/*.ino | head -n 1)"
          cp "$SRC_INO" "$SKETCH_DIR/esp32_marauder_rewired.ino"
          rsync -a scaffold/ "$SKETCH_DIR/"
          echo "sketch_dir=$SKETCH_DIR" >> $GITHUB_OUTPUT
          echo "Sketch dir tree (top-level):"; ls -la "$SKETCH_DIR"

      # ---------- Autogen headers ----------
      - name: Generate config.h (JSON-driven)
        shell: bash
        run: |
          set -euo pipefail
          python3 scaffold/tools/gen_user_config.py \
            --boards-json scaffold/configs/boards/boards_manifest.json \
            --defines-json scaffold/configs/defines/build_defines.json \
            --modules-json scaffold/configs/modules/modules_presets.json \
            --board-flag "${BOARD_FLAG:-}" \
            --board-label "${BOARD_LABEL:-}" \
            --out "${{ steps.prep.outputs.sketch_dir }}/.autogen/config.h"

      - name: Generate TFT_eSPI header (serial-only safe)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ steps.prep.outputs.sketch_dir }}/.tft_setup"
          python3 scaffold/tools/gen_tft_setup_json.py \
            --boards-json scaffold/configs/boards/boards_manifest.json \
            --displays-json scaffold/configs/displays/display_presets.json \
            --pins-json scaffold/configs/pins/pin_presets.json \
            --board-label "${BOARD_LABEL:-}" \
            --board-flag "${BOARD_FLAG:-}" \
            --model "${DISPLAY_MODEL:-}" \
            --tft-enabled "${DISPLAY_ENABLED:-}" \
            --out-dir "${{ steps.prep.outputs.sketch_dir }}/.tft_setup"

      # ---------- Partitions / filesystem ----------
      - name: Resolve FS/Partition and install custom CSV if present
        id: fs
        shell: bash
        run: |
          set -euo pipefail
          FS_IN="${FILESYSTEM:-}"
          PART_IN="${PARTITION:-}"
          CORE_VER="${CORE_VERSION:-2.0.11}"
          CORE_PART_DIR="$HOME/.arduino15/packages/esp32/hardware/esp32/${CORE_VER}/tools/partitions"
          FS="$FS_IN"
          PART="${PART_IN}"
          if [ -n "$PART" ]; then PART="${PART%.csv}.csv"; fi
          if [ -n "$PART" ]; then
            SRC="${GITHUB_WORKSPACE}/partitions/$PART"
            if [ -f "$SRC" ]; then
              mkdir -p "$CORE_PART_DIR"
              cp -f "$SRC" "$CORE_PART_DIR/$PART"
              echo "Installed custom partition CSV to $CORE_PART_DIR/$PART"
            fi
          fi
          echo "fs=$FS"   >> $GITHUB_OUTPUT
          echo "partition=$PART" >> $GITHUB_OUTPUT
          echo "Filesystem: ${FS:-<core default>}"
          echo "Partition:  ${PART:-<core default>}"

      # ---------- Compile ----------
      - name: Compile (Arduino CLI)
        working-directory: ${{ steps.prep.outputs.sketch_dir }}
        shell: bash
        env:
          EXTRA_FLAGS: "-I${{ steps.prep.outputs.sketch_dir }}/.tft_setup -I${{ steps.prep.outputs.sketch_dir }}/.autogen"
        run: |
          set -euo pipefail
          echo "FQBN:       ${FQBN}"
          echo "Sketch dir: $(pwd)"
          echo "Filesystem: ${FILESYSTEM:-<default>}"
          echo "Partition:  ${PARTITION:-<default>}"
          ls -la; ls -la .tft_setup || true; ls -la .autogen || true
          PART_PROP=""
          if [ -n "${{ steps.fs.outputs.partition }}" ]; then
            PART_PROP="--build-property build.partitions=${{ steps.fs.outputs.partition }}"; PART_PROP="${PART_PROP%.csv}"
          fi
          arduino-cli compile \
            --fqbn "$FQBN" \
            --warnings none \
            --export-binaries \
            --build-property "compiler.cpp.extra_flags=${EXTRA_FLAGS}" \
            ${PART_PROP} \
            --output-dir "$GITHUB_WORKSPACE/build_out" \
            .

      - name: Inspect ELF and save build log
        shell: bash
        run: |
          set -euo pipefail
          LOG="build_log.txt"
          {
            echo "===== ESP32 Marauder Rewired Build Log ====="
            echo "Run: $GITHUB_RUN_ID"
            echo "Inputs:"
            echo "  board_choice = ${{ github.event.inputs.board_choice }}"
            echo "  core_choice  = ${{ github.event.inputs.core_choice }}"
            echo
            echo "Resolved environment:"
            echo "  BOARD_LABEL        = ${BOARD_LABEL:-<unset>}"
            echo "  BOARD_FLAG         = ${BOARD_FLAG:-<unset>}"
            echo "  BOARD_FLAG_SOURCE  = ${BOARD_FLAG_SOURCE:-<unset>}"
            echo "  FQBN               = ${FQBN:-<unset>}"
            echo "  CORE_VERSION       = ${CORE_VERSION:-<unset>}"
            echo "  FILESYSTEM         = ${FILESYSTEM:-<unset>}"
            echo "  PARTITION          = ${PARTITION:-<unset>}"
            echo
            ELF=$(find "$GITHUB_WORKSPACE/build_out" -name "*.elf" | head -n 1 || true)
            if [ -n "$ELF" ] && [ -f "$ELF" ]; then
              echo "ELF: $ELF"
              echo "--- Symbols (showMainMenu/init_tool_registry) ---"
              nm "$ELF" | grep -E "showMainMenu|init_tool_registry" || echo "<none>"
            else
              echo "No ELF found."
            fi
            echo "==============================================="
          } | tee "$LOG"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fw-${{ env.BOARD_LABEL }}-${{ env.CORE_VERSION }}
          path: build_out

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-log
          path: build_log.txt
