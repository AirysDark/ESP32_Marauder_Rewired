name: Build (Custom CSV Profiles ? ESP32 Marauder Rewired)

on:
  workflow_dispatch:
    inputs:
      board_label:
        type: choice
        description: 'Select a common Arduino-ESP32 board (or choose "Other (enter FQBN)")'
        default: 'Generic ESP32 Dev Module'
        options:
          - Generic ESP32 Dev Module
          - DOIT ESP32 DEVKIT V1
          - NodeMCU-32S
          - ESP32 DevKitC V4
          - ESP32 WROOM-DA Module
          - ESP32 WROVER Module
          - ESP32 WROVER Kit (all versions)
          - ESP32 PICO-D4
          - AI Thinker ESP32-CAM
          - Lolin D32
          - Lolin D32 Pro
          - FireBeetle2 ESP32-E
          - Heltec WiFi Kit 32 (V3)
          - ESP32-S2 Dev Module
          - ESP32-S2 Saola-1
          - Adafruit Feather ESP32-S2
          - ESP32-S3 Dev Module
          - Adafruit Feather ESP32-S3 (2MB PSRAM)
          - M5StickC / M5StickC-Plus
          - M5Stamp S3
          - Other (enter FQBN)
      fqbn_override:
        description: 'If "Other", paste exact FQBN (e.g., esp32:esp32:nodemcu-32s or esp32:esp32:esp32s3:PSRAM=enabled)'
        required: false
        default: ''
      # ? keep the rest of your inputs here ?

      profile_name:
        type: choice
        description: 'Profile from modules_presets.csv (Auto picks from manifest.json)'
        default: 'Auto (from board)'
        options:
          - Auto (from board)
          - Minimal
          - Standard
          - Full
          - Wardriver
          - Scanner
          - BLE-only
          - Displayless
          - Debug
          - Custom

      modules_csv:
        description: 'If profile_name=Custom: CSV like WIFI,BLE,WEB,SD,GPS,TOUCH,LVGL,NEOPIXEL,BUZZER,BUTTONS,BATTERY,NRF24,USB_MSC,TFT_ON,DEBUG,DUAL_WIFI,2WIFI'
        required: false
        default: ''

      pins_csv:
        description: 'Optional: Custom pins CSV (maps PIN_NAME=VALUE into -D defs)'
        required: false
        default: ''

      tft_model:
        type: choice
        description: 'Select TFT/Display model (from display_presets.csv)'
        default: 'Auto'
        options:
          - Auto
          - None
          - ILI9341
          - ILI9488
          - ST7789
          - ST7735
          - ILI9225
          - ILI9163
          - SSD1306
          - SH1106
          - SSD1331
          - GC9A01
          - ST7796
          - HX8357
          - ILI9486
          - ILI9481
          - ILI9806
          - EPD2IN9
          - EPD2IN13
          - EPD7IN5
          - RA8875

      filesystem:
        type: choice
        description: 'Filesystem override (blank = default/manifest)'
        default: ''
        options: ['', 'spiffs', 'littlefs']

      partition:
        type: choice
        description: 'Partition CSV (pretty names) ? blank uses manifest/default'
        default: 'Default (use manifest/default)'
        options:
          - 'Default (use manifest/default)'
          - 'Huge App + 1MB FS (hugeapp_1m_fs.csv)'
          - 'Marauder (LittleFS OTA) (marauder_littlefs.csv)'
          - 'Marauder (SPIFFS OTA) (marauder_spiffs_ota.csv)'
          - 'Minimal (LittleFS OTA) (min_littlefs_ota.csv)'
          - 'Minimal (SPIFFS OTA) (min_spiffs_ota.csv)'
          - 'OTA + 1MB FS (ota_1m_fs.csv)'
          - 'Marauder Default (marauder_default.csv)'

      extra_defines:
        description: 'Additional -D flags (space-separated, e.g. FOO=1 BAR)'
        required: false
        default: ''

      core_version:
        description: 'Arduino-ESP32 core'
        required: false
        default: '2.0.11'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps (jq + unzip)
        run: sudo apt-get update && sudo apt-get install -y jq unzip

      - name: Sanitize manifest.json (strip BOM/CRLF and validate if present)
        shell: bash
        run: |
          set -euo pipefail
          MAN=./scaffold/configs/manifest.json
          if [ -f "$MAN" ]; then
            MAGIC="$(head -c 3 "$MAN" | od -An -tx1 | tr -d ' \n')"
            if [ "$MAGIC" = "efbbbf" ]; then
              tail -c +4 "$MAN" > "$MAN.nobom" && mv "$MAN.nobom" "$MAN"
              echo "Removed UTF-8 BOM from manifest.json"
            fi
            sed -i 's/\r$//' "$MAN"
            jq . "$MAN" >/dev/null
            echo "manifest.json OK"
          else
            echo "manifest.json not present; continuing (fallback map will be used if needed)"
          fi

      # Resolve a working FQBN
      - name: Resolve FQBN
        id: map
        shell: bash
        run: |
          set -e
          LABEL="${{ github.event.inputs.board_label }}"
          OVR="${{ github.event.inputs.fqbn_override }}"
          MAN="scaffold/configs/manifest.json"
          set_out() { echo "$1=$2" >> $GITHUB_OUTPUT; }
          if [ "$LABEL" = "Other (enter FQBN)" ]; then
            if [ -z "$OVR" ]; then
              echo "::error ::You chose 'Other' but did not provide fqbn_override"; exit 1
            fi
            set_out fqbn "$OVR"
            exit 0
          fi
          FOUND=""
          if [ -f "$MAN" ]; then
            FQBN=$(jq -r --arg L "$LABEL" '[.boards[] | select(.label==$L)][0].fqbn // empty' "$MAN")
            if [ -n "$FQBN" ]; then
              FOUND="yes"; set_out fqbn "$FQBN"; echo "Resolved (manifest): $LABEL -> $FQBN"
            fi
          fi
          if [ -z "$FOUND" ]; then
            case "$LABEL" in
              "Generic ESP32 Dev Module") FQBN="esp32:esp32:esp32" ;;
              "DOIT ESP32 DEVKIT V1")     FQBN="esp32:esp32:esp32doit-devkit-v1" ;;
              "NodeMCU-32S")              FQBN="esp32:esp32:nodemcu-32s" ;;
              "ESP32 DevKitC V4")         FQBN="esp32:esp32:esp32" ;;
              "ESP32 WROOM-DA Module")    FQBN="esp32:esp32:esp32da" ;;
              "ESP32 WROVER Module")      FQBN="esp32:esp32:esp32wrover" ;;
              "ESP32 WROVER Kit (all versions)") FQBN="esp32:esp32:esp32wroverkit" ;;
              "ESP32 PICO-D4")            FQBN="esp32:esp32:pico32" ;;
              "AI Thinker ESP32-CAM")     FQBN="esp32:esp32:esp32cam" ;;
              "Lolin D32")                FQBN="esp32:esp32:lolin_d32" ;;
              "Lolin D32 Pro")            FQBN="esp32:esp32:lolin_d32_pro" ;;
              "FireBeetle2 ESP32-E")      FQBN="esp32:esp32:dfrobot_firebeetle2_esp32e" ;;
              "Heltec WiFi Kit 32 (V3)")  FQBN="esp32:esp32:heltec_wifi_kit_32_V3" ;;
              "ESP32-S2 Dev Module")      FQBN="esp32:esp32:esp32s2" ;;
              "ESP32-S2 Saola-1")         FQBN="esp32:esp32:esp32s2-saola-1" ;;
              "Adafruit Feather ESP32-S2") FQBN="esp32:esp32:adafruit_feather_esp32s2" ;;
              "ESP32-S3 Dev Module")      FQBN="esp32:esp32:esp32s3" ;;
              "Adafruit Feather ESP32-S3 (2MB PSRAM)") FQBN="esp32:esp32:adafruit_feather_esp32s3" ;;
              "M5StickC / M5StickC-Plus") FQBN="esp32:esp32:m5stick-c" ;;
              "M5Stamp S3")               FQBN="esp32:esp32:m5stack_stampS3" ;;
              *) echo "::error ::Unknown board label: $LABEL"; exit 1 ;;
            esac
            set_out fqbn "$FQBN"
            echo "Resolved (fallback map): $LABEL -> $FQBN"
          fi

      - name: Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "${GITHUB_WORKSPACE}/bin" >> $GITHUB_PATH
          arduino-cli version

      - name: Configure & Install ESP32 Core
        id: core
        run: |
          CORE_VER="${{ github.event.inputs.core_version }}"
          echo "core_ver=$CORE_VER" >> $GITHUB_OUTPUT
          arduino-cli config init --additional-urls "https://github.com/espressif/arduino-esp32/releases/download/${CORE_VER}/package_esp32_dev_index.json"
          arduino-cli core update-index
          arduino-cli core install "esp32:esp32@${CORE_VER}"

      # Use your pre-bundled libraries tar (optional)
      - name: Extract pre-bundled libs (lib.tar)
        run: |
          mkdir -p $HOME/Arduino/libraries
          [ -f lib.tar ] && tar -xf lib.tar -C $HOME/Arduino/libraries
          ls -1 $HOME/Arduino/libraries || true

      # Registry lib
      - name: Create ESP32MarauderRegistry local library
        run: |
          LIBDIR="$HOME/Arduino/libraries/ESP32MarauderRegistry"
          mkdir -p "$LIBDIR/src/registry"
          cp -r scaffold/registry/* "$LIBDIR/src/registry/" || true
          echo -e "name=ESP32MarauderRegistry\nversion=0.0.3\narchitectures=*\nincludes=registry/ToolRegistry.h" > "$LIBDIR/library.properties"

      # TFT header
      - name: Configure TFT_eSPI header
        id: tft
        run: |
          USE="${{ steps.map.outputs.tft_enabled }}"
          HDR="${{ steps.map.outputs.tft_header }}"
          if [ "$USE" = "true" ] && [ -n "$HDR" ]; then
            TE="$HOME/Arduino/libraries/TFT_eSPI"
            mkdir -p "$TE"
            echo "// Auto-generated" > "$TE/User_Setup_Select.h"
            echo "#include <${HDR}>" >> "$TE/User_Setup_Select.h"
            echo "tft_define=-DENABLE_TFT" >> $GITHUB_OUTPUT
          fi
          
          # Apply display_presets.csv header if chosen
      - name: Configure display header (display_presets.csv)
        id: disp
        shell: bash
        run: |
          HDR="${{ steps.disp.outputs.disp_header }}"
          if [ -n "$HDR" ]; then
            TE="$HOME/Arduino/libraries/TFT_eSPI"
            mkdir -p "$TE"
            echo "// Auto-generated by workflow" > "$TE/User_Setup_Select.h"
            echo "#include <${HDR}>" >> "$TE/User_Setup_Select.h"
            echo "Applied TFT header from display_presets: $HDR"
          else
            echo "No display header selected from presets."
          fi

      # Prepare sketch
      - name: Prepare Sketch Folder
        id: prep
        run: |
          SKETCH_DIR="${PWD}/_build/esp32_marauder_rewired"
          rm -rf "$SKETCH_DIR"; mkdir -p "$SKETCH_DIR"
          SRC_INO="$(ls scaffold/*.ino | head -n 1)"
          cp "$SRC_INO" "$SKETCH_DIR/esp32_marauder_rewired.ino"
          cp -r scaffold/* "$SKETCH_DIR/" || true
          echo "sketch_dir=$SKETCH_DIR" >> $GITHUB_OUTPUT

      # Resolve modules
      - name: Resolve modules
        id: mods
        run: |
          PRESETS="modules_presets.csv"
          CHOICE="${{ github.event.inputs.profile_name }}"
          CUSTOM="${{ github.event.inputs.modules_csv }}"
          if [ "$CHOICE" = "Custom" ]; then
            echo "csv=$CUSTOM" >> $GITHUB_OUTPUT; exit 0
          fi
          LINE=$(awk -F',' -v want="$CHOICE" 'tolower($1)==tolower(want){$1="";sub(/^,/, "");print;exit}' "$PRESETS")
          echo "csv=$LINE" >> $GITHUB_OUTPUT
          
      # Resolve display
      - name: Resolve display (from display_presets.csv)
        id: disp
        shell: bash
        run: |
          set -e
          PRESETS="${GITHUB_WORKSPACE}/scaffold/configs/displays/display_presets.csv"
          CHOICE="${{ github.event.inputs.tft_model }}"

          if [ "$CHOICE" = "Auto" ]; then
            echo "Auto-selected display (from manifest.json or defaults)"
            echo "disp_header="   >> $GITHUB_OUTPUT
            echo "disp_define="   >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$CHOICE" = "None" ]; then
            echo "Displayless build"
            echo "disp_header="   >> $GITHUB_OUTPUT
            echo "disp_define="   >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ ! -f "$PRESETS" ]; then
            echo "::error ::display_presets.csv not found at $PRESETS"
            exit 1
          fi

          LINE=$(awk -F',' -v want="$CHOICE" '
            BEGIN{IGNORECASE=1}
            /^[[:space:]]*#/ {next}
            NF>=3 {
              m=$2; gsub(/^[[:space:]]+|[[:space:]]+$/, "", m);
              if (m==want) { print $3 "," $4; exit }
            }' "$PRESETS")

          if [ -z "$LINE" ]; then
            echo "::error ::Display '$CHOICE' not found in display_presets.csv"
            exit 1
          fi

          HDR=$(echo "$LINE" | cut -d',' -f1)
          DEF=$(echo "$LINE" | cut -d',' -f2)

          echo "Resolved display: $CHOICE -> header=$HDR define=$DEF"
          echo "disp_header=$HDR" >> $GITHUB_OUTPUT
          echo "disp_define=$DEF" >> $GITHUB_OUTPUT

      # Resolve FS/Partition
      - name: Resolve FS/Partition
        id: fs
        run: |
          CORE_VER="${{ github.event.inputs.core_version }}"
          PART_IN="${{ github.event.inputs.partition }}"
          if [[ "$PART_IN" =~ \(([^)]+\.csv)\)$ ]]; then
            PART="${BASH_REMATCH[1]}"
            SRC="partitions/$PART"
            DEST="$HOME/.arduino15/packages/esp32/hardware/esp32/${CORE_VER}/tools/partitions"
            mkdir -p "$DEST"; cp "$SRC" "$DEST/$PART"
            echo "part=$PART" >> $GITHUB_OUTPUT
          fi
          
          # Resolve TFT/Display from display_presets.csv
      - name: Resolve TFT/Display
        id: disp
        shell: bash
        run: |
          set -euo pipefail
          PRESET="${{ github.event.inputs.tft_model }}"
          CSV="configs/pins/display_presets.csv"

          out(){ echo "$1=$2" >> $GITHUB_OUTPUT; }

          # defaults
          out disp_define ""
          out disp_header  ""

          if [ "$PRESET" = "Auto" ]; then
            echo "TFT model = Auto -> following manifest or defaults."
            exit 0
          fi

          if [ "$PRESET" = "None" ]; then
            echo "TFT model = None -> no display."
            exit 0
          fi

          [ -f "$CSV" ] || { echo "::error ::$CSV not found"; exit 1; }

          LINE=$(awk -F',' -v want="$PRESET" '
            BEGIN{IGNORECASE=1}
            /^[[:space:]]*#/ {next}
            NF>=4 {
              m=$2; gsub(/^[[:space:]]+|[[:space:]]+$/, "", m);
              if (m==want) { print; exit }
            }' "$CSV")

          if [ -z "$LINE" ]; then
            echo "::error ::TFT model '$PRESET' not found in $CSV"
            exit 1
          fi

          IFS=',' read -r profile model header defines <<< "$LINE"

          header="$(echo "$header" | xargs)"
          defines="$(echo "$defines" | xargs)"

          if [ -n "$header" ]; then
            out disp_header "$header"
          fi
          
          # Apply TFT_eSPI header file
      - name: Configure TFT_eSPI header
        shell: bash
        run: |
          HDR="${{ steps.disp.outputs.disp_header }}"
          if [ -n "$HDR" ]; then
            TE="$HOME/Arduino/libraries/TFT_eSPI"
            mkdir -p "$TE"
            echo "// Auto-generated by workflow" > "$TE/User_Setup_Select.h"
            echo "#include <${HDR}>" >> "$TE/User_Setup_Select.h"
            echo "Applied TFT_eSPI header: $HDR"
          else
            echo "No TFT header applied."
          fi

      # ---------------------------------------------------------------------------
      # Resolve pins (Custom CSV)
      # ---------------------------------------------------------------------------
      - name: Resolve pins (Custom CSV)
        id: pins
        shell: bash
        run: |
          PINS_IN="${{ github.event.inputs.pins_csv }}"
          OUT=""
          if [ -n "$PINS_IN" ]; then
            FILE="scaffold/configs/pins/$PINS_IN"
            if [ ! -f "$FILE" ]; then
              echo "::error ::Pins CSV '$FILE' not found"; exit 1
            fi
            while IFS=',' read -r k v; do
              # skip empty lines or comments
              [[ -z "$k" || "$k" =~ ^# ]] && continue
              [ -n "$v" ] && OUT="$OUT -D$k=$v"
            done < "$FILE"
          fi
          echo "pins_defs=$OUT" >> $GITHUB_OUTPUT
          echo "Pin defines => $OUT"

      # Compose defines
      - name: Compose defines
        id: defs
        run: |
          D=""; CSV_FLAGS="${{ steps.mods.outputs.csv }}"
          add () { [[ "$CSV_FLAGS" == *"$1"* ]] && D="$D -D$2"; }
          add WIFI ENABLE_WIFI
          add BLE ENABLE_BLE
          add WEB ENABLE_WEB
          add SD ENABLE_SD
          add GPS ENABLE_GPS
          add TOUCH ENABLE_TOUCH
          add LVGL ENABLE_LVGL
          add NEOPIXEL ENABLE_NEOPIXEL
          add BUZZER ENABLE_BUZZER
          add BUTTONS ENABLE_BUTTONS
          add BATTERY ENABLE_BATTERY
          add NRF24 ENABLE_NRF24
          add USB_MSC ENABLE_USB_MSC
          add DUAL_WIFI ENABLE_DUAL_WIFI
          add 2WIFI ENABLE_2WIFI
          PIN_DEFS="${{ steps.pins.outputs.pins_defs }}"
          [ -n "$PIN_DEFS" ] && D="$D $PIN_DEFS"
          EXTRA="${{ github.event.inputs.extra_defines }}"
          [ -n "$EXTRA" ] && for t in $EXTRA; do D="$D -D$t"; done
          echo "defs=$D" >> $GITHUB_OUTPUT
          
          DISP_DEF="${{ steps.disp.outputs.disp_define }}"
          if [ -n "$DISP_DEF" ]; then
            D="$D -D$DISP_DEF"
          fi

      # Compile
      - name: Compile (Arduino CLI)
        run: |
          FQBN="${{ steps.map.outputs.fqbn }}"
          SKETCH_DIR="${{ steps.prep.outputs.sketch_dir }}"
          DEFS="${{ steps.defs.outputs.defs }} ${{ steps.pins.outputs.pins_defs }}"
          FS="${{ steps.fs.outputs.fs }}"
          PART="${{ steps.fs.outputs.part }}"
          CPP_FLAGS="$DEFS"
          ARGS=(--fqbn "$FQBN" --warnings none --export-binaries \
            --build-property "compiler.cpp.extra_flags=$CPP_FLAGS" \
            --build-property "compiler.c.extra_flags=$CPP_FLAGS")
          [ -n "$FS" ] && ARGS+=(--build-property "board_build.filesystem=$FS")
          [ -n "$PART" ] && ARGS+=(--build-property "build.partitions=${PART%.csv}")
          arduino-cli compile "${ARGS[@]}" "$SKETCH_DIR"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: fw_${{ github.event.inputs.board_label }}_${{ github.sha }}
          path: _build/esp32_marauder_rewired/build/*/*.bin
          if-no-files-found: warn
          retention-days: 14
